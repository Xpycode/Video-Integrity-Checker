# Session: 2026-02-25

## Goal
Full implementation of VideoAnalyzer — from zero code to working macOS app via wave-based parallel execution.

## Context
- Previous session: Discovery/planning — architecture decided, implementation plan created
- Current phase: implementation

## Progress

### Completed
- [x] Wave 1: Xcode project (XcodeGen), SwiftUI app entry point, 5 data models
- [x] Wave 2: AVFoundation analyzer (frame-by-frame decode), FFmpeg analyzer (Process-based), Analysis coordinator
- [x] Wave 3: DropZoneView (drag-and-drop + NSOpenPanel), FileListView (SwiftUI Table), DetailView (inspector)
- [x] Wave 4: AnalyzerViewModel (@Observable @MainActor), SettingsView, full UI wiring with NavigationSplitView
- [x] Wave 5: Toolbar/menus (Cmd+O, delete), progress bars, Cancel All, error handling (zero-byte, unreadable)
- [x] UI polish: VSplitView layout (list top, detail bottom), compact status banner, 3-column detail layout
- [x] Improved error messages with frame count, timestamp, percentage, AVError codes
- [x] Fixed table not filling full window width — added `maxWidth: .infinity` to VSplitView and both panes

### Decisions Made
- XcodeGen for project generation (reproducible, no pbxproj merge conflicts)
- VSplitView (top/bottom) instead of NavigationSplitView (rejected Tahoe sidebar — too narrow)
- Issues section first in detail view (most important info at top)
- 3-column detail: File Info | Media Info | Tracks (use horizontal space)

### Discovered
- `AVAssetTrack.mediaType` is synchronous (not async-loadable) — caused build error when using `track.load(.mediaType)`
- `engineFor(url:)` needed to be `async` because accessing `ffmpegAnalyzer.isAvailable` crosses actor boundary (Swift 6)
- SwiftUI `RoundedRectangle().fill().overlay()` expands to fill space — use `HStack.background()` instead for content-hugging
- SwiftUI Table columns with fixed `.width()` don't fill available space — need `min/ideal/max`
- Test file (5F5A0556.MP4, 1.12GB 4K HEVC) decoded 1704 of ~2750 frames (61%) before failing with error -11821

## Next Session
- Test with more media files (various formats, known-good, known-corrupt)
- Performance check with large files (memory during analysis)
- Unit tests for analysis engines
- Consider auto-selecting first file when added
- ~~The narrow table issue may still need investigation~~ — **Fixed**: VSplitView and pane frames needed explicit `maxWidth: .infinity`

## Notes
- Wave-based execution worked well: 6 agents in parallel for Waves 2+3
- One agent (FFmpegAnalyzer) silently failed to write its file — had to recreate manually
- Total: 13 Swift files, 6 commits, Swift 6 strict concurrency throughout
- App successfully analyzes real media files and reports decode errors with detailed context

---

## Session 2 — Container Inspection System

### Goal
Diagnose WHY decode errors happen, not just report them. Build container-level analysis for MP4/MOV/MXF.

### Context
- Test file `5F5A0556.MP4` (4K HEVC 10-bit 4:2:2, 50fps, 162 Mbps) reported "Decode Error at frame 1704"
- Manual investigation revealed: ffmpeg decodes all 2750 frames with zero errors — file data is intact
- Root cause: broken edit list (`elst` atom) — media_time=1000 references a timestamp with no keyframe in `stss`
- AVFoundation, AME, Compressor all fail on this; ffmpeg's demuxer is more forgiving
- User also has AME→AVC-Intra MXF OP1a→VPMS (Arvato) MAM pipeline where this causes green frames

### Progress

#### Completed
- [x] Designed protocol-based `ContainerInspector` architecture (extensible for MP4/MXF/MPEG-TS)
- [x] Built `ISOBMFFInspector` — pure Swift binary parser for MP4/MOV/M4V containers
  - Box/atom tree walker (recursive, depth-limited)
  - Edit list (`elst`) parsing and validation against sync sample table (`stss`)
  - Composition time offset (`ctts`) parsing
  - Sample-to-time (`stts`) parsing with keyframe timestamp computation
  - Media header (`mdhd`) timescale extraction
  - Track type detection via `hdlr` handler type
  - Top-level structure validation (ftyp/moov/mdat presence, ordering, truncation)
- [x] Created `MXFInspector` stub — detects MXF files, identifies operational pattern (OP1a/OPAtom), ready for KLV implementation
- [x] Built `ContainerInspectorRegistry` — routes files to correct inspector by extension + magic bytes
- [x] Integrated container inspection as pre-pass in `AnalysisCoordinator` (runs before frame decode)
- [x] Added 3 new `IssueType` cases: `.containerMetadata`, `.containerStructure`, `.engineMismatch`
- [x] Severity escalation: container warnings auto-escalate to errors when they cause a decode failure
- [x] Issue linking: container diagnostic says "This is the likely cause of the decode failure below"
- [x] Updated `DetailView` with archivebox icons for container issues
- [x] Added MXF to ffmpeg extensions and drop zone supported extensions
- [x] All files added to Xcode project, clean build with zero warnings

#### Tested
- Analyzed `5F5A0556.MP4` — app now shows:
  1. **Container Metadata (error):** "Track 0 edit list entry 0 starts at media_time=1000 but nearest preceding keyframe is 20.0ms earlier... [Fixable by remux] — This is the likely cause of the decode failure below."
  2. **Decode Error:** "Decode failed after 1704 frames (61% of file) at 00:00:34. Cannot Decode (error -11821)"
- Banner correctly shows "2 Errors" (escalated from 1 Error + 1 Warning)

### Decisions Made
- Container inspection runs as pre-pass (before decode), not post-pass — user sees root cause first
- ISOBMFF inspector uses `Data(contentsOf:options:.mappedIfSafe)` — memory-maps file, only reads header/moov pages
- Protocol-based architecture: `ContainerInspector` protocol → `ISOBMFFInspector`, `MXFInspector`, future `TSInspector`
- `Remediation` enum on diagnostics: `.remux` vs `.reencode` vs `.none` — tells user if fixable
- MXF scope: OP1a only (matches user's broadcast chain: AME → MXF OP1a → VPMS MAM)
- Repair/remux is a separate app project — this app is analysis only

### Discovered
- Error -11821 (`kVTVideoDecoderBadDataErr`) from AVFoundation is caused by malformed edit list, not actual data corruption
- ffmpeg decodes 100% of frames in the same file — the video bitstream is intact
- The `elst` media_time=1000 (20ms into a 50fps track) doesn't align with any stss keyframe
- AME/Compressor fail the same way; VPMS MAM produces green frames from the broken container metadata
- Premiere Pro is more forgiving (like ffmpeg) and can work with these files

### New Files (4)
```
Services/ContainerInspection/
├── ContainerInspector.swift         — Protocol, diagnostic model, metadata types
├── ContainerInspectorRegistry.swift — Routes files to correct inspector
├── ISOBMFFInspector.swift           — MP4/MOV box parser + validation
└── MXFInspector.swift               — MXF stub (OP detection, ready for KLV)
```

### Modified Files (4)
- `Models/MediaIssue.swift` — added containerMetadata, containerStructure, engineMismatch
- `Services/AnalysisCoordinator.swift` — container pre-pass, issue merging, severity escalation
- `Views/DetailView.swift` — new issue type display names + archivebox icons
- `Views/DropZoneView.swift` — added .mxf to supported extensions

## Next Session
- Implement MXF OP1a inspector (KLV parsing, partition packs, index tables, essence descriptors)
- Test with more broken files (various corruption types)
- Consider dual-engine cross-reference (run both AVFoundation + ffmpeg, compare results)
- Vision framework artifact detection (green frames, macroblocking) — Apple ML path
